<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Market Simulator</title>
  <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #0e0e0e;
      color: #fff;
      display: flex;
      flex-direction: row;
      height: 100vh;
      overflow: hidden;
    }
    #sidebar {
      width: 220px;
      background: #1b1b1b;
      padding: 1rem;
      overflow-y: auto;
      border-right: 1px solid #333;
    }
    #sidebar h2 {
      font-size: 1.1rem;
      margin-top: 1rem;
    }
    .asset {
      cursor: pointer;
      padding: 5px;
      margin: 2px 0;
      background: #2a2a2a;
      border-radius: 5px;
    }
    .asset:hover {
      background: #444;
    }
    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    #top-bar {
      display: flex;
      justify-content: space-between;
      padding: 1rem;
      background: #111;
      border-bottom: 1px solid #333;
    }
    #chart {
      flex: 1;
    }
    #controls {
      display: flex;
      gap: 10px;
      align-items: center;
      padding: 0.5rem;
      background: #111;
      justify-content: center;
      flex-wrap: wrap;
    }
    #controls button {
      background: #333;
      color: #fff;
      padding: 5px 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #controls button:hover {
      background: #555;
    }
    #trade-panel {
      padding: 1rem;
      background: #111;
      border-top: 1px solid #333;
    }
    #trade-panel input {
      width: 80px;
      padding: 5px;
      margin: 0 5px;
      background: #222;
      border: 1px solid #444;
      color: #fff;
    }
    @media(max-width: 768px) {
      #sidebar {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div id="sidebar">
    <h2>Commodities</h2>
    <div class="asset" onclick="renderChart('XAUUSD')">Gold</div>
    <div class="asset" onclick="renderChart('XAGUSD')">Silver</div>
    <h2>Stocks</h2>
    <div class="asset" onclick="renderChart('AAPL')">Apple</div>
    <div class="asset" onclick="renderChart('MSFT')">Microsoft</div>
    <h2>Crypto</h2>
    <div class="asset" onclick="renderChart('BTCUSD')">Bitcoin</div>
    <div class="asset" onclick="renderChart('ETHUSD')">Ethereum</div>
    <h2>Forex</h2>
    <div class="asset" onclick="renderChart('EURUSD')">EUR/USD</div>
    <div class="asset" onclick="renderChart('USDJPY')">USD/JPY</div>
  </div>

  <div id="main">
    <div id="top-bar">
      <div>Balance: ₦<span id="balance">50000</span></div>
      <div>Selected Asset: <span id="asset-name">AAPL</span></div>
    </div>

    <div id="controls">
      <button onclick="setTimeframe('1D')">1D</button>
      <button onclick="setTimeframe('1W')">1W</button>
      <button onclick="setTimeframe('1M')">1M</button>
      <button onclick="setTimeframe('1Y')">1Y</button>
    </div>

    <div id="chart"></div>

    <div id="trade-panel">
      Amount: <input type="number" id="amount" value="1000" />
      <button onclick="buy()">Buy</button>
      <button onclick="sell()">Sell</button>
    </div>
  </div>

  <script>
    const API_KEY = 'S0CBS8L9QUAVNI6W';
    let balance = 50000;
    let currentSymbol = 'AAPL';
    let currentTimeframe = '1D';
    let chart, series;

    function initChart() {
      chart = LightweightCharts.createChart(document.getElementById('chart'), {
        layout: {
          background: { color: '#0e0e0e' },
          textColor: '#d1d4dc'
        },
        width: window.innerWidth - 220,
        height: 400,
        grid: {
          vertLines: { color: '#333' },
          horzLines: { color: '#333' }
        },
        crosshair: {
          mode: 0,
        },
        timeScale: {
          timeVisible: true,
          secondsVisible: false,
        }
      });
      series = chart.addCandlestickSeries();
    }

    async function fetchData(symbol, timeframe) {
      const intervalMap = {
        '1D': '60min',
        '1W': '60min',
        '1M': 'daily',
        '1Y': 'weekly'
      };
      const func = intervalMap[timeframe] === '60min'
        ? 'TIME_SERIES_INTRADAY'
        : 'TIME_SERIES_' + intervalMap[timeframe].toUpperCase();

      const interval = intervalMap[timeframe];
      const url = `https://www.alphavantage.co/query?function=${func}&symbol=${symbol}&interval=${interval}&apikey=${API_KEY}`;
      try {
        const res = await fetch(url);
        const json = await res.json();
        const key = Object.keys(json).find(k => k.includes('Time Series'));

        if (!key) throw new Error('No data key found');

        return Object.entries(json[key]).slice(0, 100).reverse().map(([time, d]) => ({
          time: Math.floor(new Date(time).getTime() / 1000),
          open: +d['1. open'],
          high: +d['2. high'],
          low: +d['3. low'],
          close: +d['4. close'],
        }));
      } catch (e) {
        console.error('Fetch failed:', e.message);
        return [];
      }
    }

    async function renderChart(symbol = currentSymbol) {
      currentSymbol = symbol;
      document.getElementById('asset-name').innerText = symbol;
      const data = await fetchData(symbol, currentTimeframe);
      if (data.length > 0) {
        series.setData(data);
      }
    }

    function setTimeframe(tf) {
      currentTimeframe = tf;
      renderChart(currentSymbol);
    }

    function buy() {
      const amt = +document.getElementById('amount').value;
      if (amt <= balance) {
        balance -= amt;
        updateBalance();
        alert(`Bought ₦${amt} of ${currentSymbol}`);
      } else {
        alert("Not enough balance");
      }
    }

    function sell() {
      const amt = +document.getElementById('amount').value;
      balance += amt;
      updateBalance();
      alert(`Sold ₦${amt} of ${currentSymbol}`);
    }

    function updateBalance() {
      document.getElementById('balance').innerText = balance.toFixed(2);
    }

    window.onload = () => {
      initChart();
      renderChart();
    };
  </script>
</body>
</html>
