<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Market Simulator - Candlestick Chart</title>
<script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
<style>
  body {
    background: #121212;
    color: #eee;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }
  header {
    padding: 1rem;
    background: #1f1f1f;
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    justify-content: center;
  }
  button {
    background: #333;
    border: none;
    color: #eee;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    transition: background 0.3s ease;
  }
  button:hover, button.active {
    background: #4caf50;
    color: #fff;
  }
  #chart {
    flex-grow: 1;
    min-height: 400px;
    max-width: 1000px;
    margin: 1rem auto;
  }
  @media (max-width: 600px) {
    #chart {
      height: 300px !important;
      width: 95vw !important;
    }
    button {
      flex: 1 1 30%;
      font-size: 0.9rem;
    }
  }
</style>
</head>
<body>

<header>
  <button data-timeframe="1D">1 Day</button>
  <button data-timeframe="1W" class="active">1 Week</button>
  <button data-timeframe="1M">1 Month</button>
  <button data-timeframe="3M">3 Months</button>
  <button data-timeframe="6M">6 Months</button>
  <button data-timeframe="1Y">1 Year</button>
  <button data-timeframe="5Y">5 Years</button>
</header>

<div id="chart"></div>

<script>
  const API_KEY = 'S0CBS8L9QUAVNI6W'; // Your API key here
  const chart = LightweightCharts.createChart(document.getElementById('chart'), {
    width: window.innerWidth > 1000 ? 1000 : window.innerWidth * 0.95,
    height: window.innerWidth > 600 ? 600 : 300,
    layout: {
      backgroundColor: '#121212',
      textColor: '#d1d4dc',
    },
    grid: {
      vertLines: { color: '#334158' },
      horzLines: { color: '#334158' },
    },
    crosshair: {
      mode: LightweightCharts.CrosshairMode.Normal,
    },
    rightPriceScale: {
      borderColor: '#485c7b',
    },
    timeScale: {
      borderColor: '#485c7b',
      timeVisible: true,
      secondsVisible: false,
    },
  });

  const candleSeries = chart.addCandlestickSeries();

  window.addEventListener('resize', () => {
    chart.applyOptions({ width: window.innerWidth > 1000 ? 1000 : window.innerWidth * 0.95, height: window.innerWidth > 600 ? 600 : 300 });
  });

  // Map timeframe to Alpha Vantage function and interval
  const timeframeMap = {
    '1D': { func: 'TIME_SERIES_INTRADAY', interval: '60min' },
    '1W': { func: 'TIME_SERIES_DAILY', interval: null },
    '1M': { func: 'TIME_SERIES_DAILY', interval: null },
    '3M': { func: 'TIME_SERIES_DAILY', interval: null },
    '6M': { func: 'TIME_SERIES_DAILY', interval: null },
    '1Y': { func: 'TIME_SERIES_WEEKLY', interval: null },
    '5Y': { func: 'TIME_SERIES_MONTHLY', interval: null },
  };

  // We'll use AAPL as example symbol; you can expand this later
  const symbol = 'AAPL';

  async function fetchData(timeframe) {
    const config = timeframeMap[timeframe];
    let url = '';
    if (!config) {
      alert('Unsupported timeframe');
      return [];
    }
    if (config.func === 'TIME_SERIES_INTRADAY') {
      url = `https://www.alphavantage.co/query?function=${config.func}&symbol=${symbol}&interval=${config.interval}&apikey=${API_KEY}`;
    } else {
      url = `https://www.alphavantage.co/query?function=${config.func}&symbol=${symbol}&apikey=${API_KEY}`;
    }

    try {
      const res = await fetch(url);
      const json = await res.json();

      if (json['Note']) {
        alert('API call frequency exceeded. Please wait a minute and try again.');
        return [];
      }
      if (json['Error Message']) {
        alert('Error from API: ' + json['Error Message']);
        return [];
      }

      let dataKey = null;
      if (config.func === 'TIME_SERIES_INTRADAY') dataKey = 'Time Series (' + config.interval + ')';
      else if (config.func === 'TIME_SERIES_DAILY') dataKey = 'Time Series (Daily)';
      else if (config.func === 'TIME_SERIES_WEEKLY') dataKey = 'Weekly Time Series';
      else if (config.func === 'TIME_SERIES_MONTHLY') dataKey = 'Monthly Time Series';

      const data = json[dataKey];
      if (!data) {
        alert('No data found');
        return [];
      }

      let result = Object.entries(data).map(([dateStr, val]) => {
        // Alpha Vantage date format is "YYYY-MM-DD" or "YYYY-MM-DD HH:mm:ss" for intraday
        const date = new Date(dateStr);
        const time = Math.floor(date.getTime() / 1000);

        return {
          time,
          open: parseFloat(val['1. open']),
          high: parseFloat(val['2. high']),
          low: parseFloat(val['3. low']),
          close: parseFloat(val['4. close']),
        };
      });

      // Sort ascending by time
      result = result.sort((a, b) => a.time - b.time);

      // Limit data based on timeframe:
      const now = new Date();
      let cutoffDate = new Date();
      switch (timeframe) {
        case '1D': cutoffDate.setDate(now.getDate() - 1); break;
        case '1W': cutoffDate.setDate(now.getDate() - 7); break;
        case '1M': cutoffDate.setMonth(now.getMonth() - 1); break;
        case '3M': cutoffDate.setMonth(now.getMonth() - 3); break;
        case '6M': cutoffDate.setMonth(now.getMonth() - 6); break;
        case '1Y': cutoffDate.setFullYear(now.getFullYear() - 1); break;
        case '5Y': cutoffDate.setFullYear(now.getFullYear() - 5); break;
        default: cutoffDate = new Date(0); // All data
      }
      result = result.filter(d => d.time >= Math.floor(cutoffDate.getTime() / 1000));

      return result;
    } catch (err) {
      alert('Failed to fetch data: ' + err.message);
      return [];
    }
  }

  async function updateChart(timeframe) {
    candleSeries.setData([]);
    const data = await fetchData(timeframe);
    if (data.length === 0) return;
    candleSeries.setData(data);
  }

  // Setup buttons
  const buttons = document.querySelectorAll('header button');
  buttons.forEach(btn => {
    btn.addEventListener('click', () => {
      buttons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      updateChart(btn.dataset.timeframe);
    });
  });

  // Load default timeframe data
  updateChart('1W');

</script>
</body>
</html>
